<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cross-Device Test - PocketCloud</title>
  <link rel="stylesheet" href="/css/style.css">
  <style>
    .test-container {
      max-width: 800px;
      margin: 2rem auto;
      padding: 2rem;
      background: #f8f9fa;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .test-header {
      text-align: center;
      margin-bottom: 2rem;
    }
    
    .test-section {
      background: white;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      border-radius: 6px;
      border-left: 4px solid #007bff;
    }
    
    .test-result {
      padding: 1rem;
      border-radius: 6px;
      margin: 1rem 0;
      font-family: monospace;
    }
    
    .test-success {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
    }
    
    .test-error {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
    }
    
    .test-info {
      background: #d1ecf1;
      border: 1px solid #bee5eb;
      color: #0c5460;
    }
    
    .btn {
      background: #007bff;
      color: white;
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
      margin: 0.5rem;
    }
    
    .btn:hover {
      background: #0056b3;
    }
    
    .btn-success {
      background: #28a745;
    }
    
    .btn-success:hover {
      background: #1e7e34;
    }
    
    .loading {
      display: none;
      text-align: center;
      padding: 1rem;
    }
    
    .device-info {
      background: #e9ecef;
      padding: 1rem;
      border-radius: 6px;
      margin: 1rem 0;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="test-container">
      <div class="test-header">
        <h1>üîß Cross-Device Access Test</h1>
        <p>Test your ability to access encrypted files from this device</p>
      </div>
      
      <div class="test-section">
        <h3>üì± Device Information</h3>
        <div class="device-info" id="deviceInfo">
          <p><strong>User:</strong> <%= username %></p>
          <p><strong>Device:</strong> <span id="userAgent">Loading...</span></p>
          <p><strong>IP Address:</strong> <span id="ipAddress">Loading...</span></p>
          <p><strong>Timestamp:</strong> <span id="timestamp">Loading...</span></p>
        </div>
      </div>
      
      <div class="test-section">
        <h3>üîê Session Status</h3>
        <div id="sessionStatus" class="test-result test-info">
          Click "Test Session" to check your login status...
        </div>
        <button onclick="testSession()" class="btn">Test Session</button>
      </div>
      
      <div class="test-section">
        <h3>üß™ Access Test</h3>
        <div id="accessTest" class="test-result test-info">
          Click "Test Access" to verify you can access your files...
        </div>
        <button onclick="testAccess()" class="btn">Test Access</button>
      </div>
      
      <div class="test-section">
        <h3>üìã Troubleshooting</h3>
        <div id="troubleshooting">
          <p><strong>If tests fail:</strong></p>
          <ol>
            <li><strong>Log out and log back in</strong> with your exact username and password</li>
            <li><strong>Clear browser cache</strong> and try again</li>
            <li><strong>Try incognito/private mode</strong> to test without cached data</li>
            <li><strong>Verify network connection</strong> - must be same network as Raspberry Pi</li>
          </ol>
        </div>
        <a href="/auth/logout" class="btn">Logout & Login Again</a>
        <a href="/files" class="btn btn-success">Back to Files</a>
      </div>
      
      <div class="loading" id="loading">
        <p>üîÑ Testing...</p>
      </div>
    </div>
  </div>

  <script>
    // Update device info
    document.getElementById('userAgent').textContent = navigator.userAgent;
    document.getElementById('timestamp').textContent = new Date().toLocaleString();
    
    // Get IP address (approximate)
    fetch('/files/session-info')
      .then(response => response.json())
      .then(data => {
        document.getElementById('ipAddress').textContent = data.ip || 'Unknown';
      })
      .catch(() => {
        document.getElementById('ipAddress').textContent = 'Unknown';
      });
    
    async function testSession() {
      const statusDiv = document.getElementById('sessionStatus');
      const loading = document.getElementById('loading');
      
      loading.style.display = 'block';
      statusDiv.innerHTML = 'Testing session...';
      statusDiv.className = 'test-result test-info';
      
      try {
        const response = await fetch('/files/session-info');
        const data = await response.json();
        
        if (data.encryptionReady) {
          statusDiv.innerHTML = `
            ‚úÖ <strong>Session OK</strong><br>
            ‚Ä¢ User: ${data.username}<br>
            ‚Ä¢ Session ID: ${data.sessionId.substring(0, 8)}...<br>
            ‚Ä¢ Encryption keys: Available<br>
            ‚Ä¢ Status: Ready for file operations
          `;
          statusDiv.className = 'test-result test-success';
        } else {
          statusDiv.innerHTML = `
            ‚ùå <strong>Session Issues</strong><br>
            ‚Ä¢ User: ${data.username}<br>
            ‚Ä¢ Session ID: ${data.sessionId.substring(0, 8)}...<br>
            ‚Ä¢ Encryption keys: Missing<br>
            ‚Ä¢ Status: Cannot decrypt files<br>
            <br><strong>Solution:</strong> Log out and log back in
          `;
          statusDiv.className = 'test-result test-error';
        }
      } catch (error) {
        statusDiv.innerHTML = `
          ‚ùå <strong>Session Test Failed</strong><br>
          Error: ${error.message}<br>
          <br><strong>Solution:</strong> Check network connection and try logging in again
        `;
        statusDiv.className = 'test-result test-error';
      }
      
      loading.style.display = 'none';
    }
    
    async function testAccess() {
      const testDiv = document.getElementById('accessTest');
      const loading = document.getElementById('loading');
      
      loading.style.display = 'block';
      testDiv.innerHTML = 'Testing file access...';
      testDiv.className = 'test-result test-info';
      
      try {
        const response = await fetch('/files/test-access');
        const data = await response.json();
        
        if (data.success && data.encryptionReady) {
          testDiv.innerHTML = `
            ‚úÖ <strong>Access Test Passed</strong><br>
            ‚Ä¢ User: ${data.username}<br>
            ‚Ä¢ Files: ${data.fileCount} files available<br>
            ‚Ä¢ Upload: ${data.canUpload ? 'Enabled' : 'Disabled'}<br>
            ‚Ä¢ Download: ${data.canDownload ? 'Enabled' : 'Disabled'}<br>
            ‚Ä¢ Status: ${data.message}
          `;
          testDiv.className = 'test-result test-success';
        } else {
          testDiv.innerHTML = `
            ‚ùå <strong>Access Test Failed</strong><br>
            ‚Ä¢ User: ${data.username || 'Unknown'}<br>
            ‚Ä¢ Files: ${data.fileCount || 0} files<br>
            ‚Ä¢ Upload: Disabled<br>
            ‚Ä¢ Download: Disabled<br>
            ‚Ä¢ Status: ${data.message}<br>
            <br><strong>Solution:</strong> Log out and log back in with your password
          `;
          testDiv.className = 'test-result test-error';
        }
      } catch (error) {
        testDiv.innerHTML = `
          ‚ùå <strong>Access Test Failed</strong><br>
          Error: ${error.message}<br>
          <br><strong>Solution:</strong> Check network connection and login status
        `;
        testDiv.className = 'test-result test-error';
      }
      
      loading.style.display = 'none';
    }
    
    // Auto-run tests on page load
    window.addEventListener('load', () => {
      setTimeout(testSession, 500);
      setTimeout(testAccess, 1000);
    });
  </script>
</body>
</html>